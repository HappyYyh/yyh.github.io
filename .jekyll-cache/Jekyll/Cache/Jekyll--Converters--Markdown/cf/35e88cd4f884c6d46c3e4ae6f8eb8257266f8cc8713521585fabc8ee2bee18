I"©<h1 id="spring-aop-å®æˆ˜">Spring AOP å®æˆ˜</h1>

<h2 id="ä¸€aopä»‹ç»">ä¸€ã€AOPä»‹ç»</h2>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	åœ¨è½¯ä»¶ä¸šï¼ŒAOPä¸ºAspect Oriented Programmingçš„ç¼©å†™ï¼Œæ„ä¸ºï¼šé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼Œé€šè¿‡é¢„ç¼–è¯‘æ–¹å¼å’Œè¿è¡ŒæœŸåŠ¨æ€ä»£ç†å®ç°ç¨‹åºåŠŸèƒ½çš„ç»Ÿä¸€ç»´æŠ¤çš„ä¸€ç§æŠ€æœ¯ã€‚AOPæ˜¯OOPçš„å»¶ç»­ï¼Œæ˜¯è½¯ä»¶å¼€å‘ä¸­çš„ä¸€ä¸ªçƒ­ç‚¹ï¼Œä¹Ÿæ˜¯Springæ¡†æ¶ä¸­çš„ä¸€ä¸ªé‡è¦å†…å®¹ï¼Œæ˜¯å‡½æ•°å¼ç¼–ç¨‹çš„ä¸€ç§è¡ç”ŸèŒƒå‹ã€‚åˆ©ç”¨AOPå¯ä»¥å¯¹ä¸šåŠ¡é€»è¾‘çš„å„ä¸ªéƒ¨åˆ†è¿›è¡Œéš”ç¦»ï¼Œä»è€Œä½¿å¾—ä¸šåŠ¡é€»è¾‘å„éƒ¨åˆ†ä¹‹é—´çš„è€¦åˆåº¦é™ä½ï¼Œæé«˜ç¨‹åºçš„å¯é‡ç”¨æ€§ï¼ŒåŒæ—¶æé«˜äº†å¼€å‘çš„æ•ˆç‡ã€‚        <span class="nt">--</span>ç™¾åº¦ç™¾ç§‘
</code></pre></div></div>

<p>â€‹		 AOPæ˜¯Springæ¡†æ¶é¢å‘åˆ‡é¢çš„ç¼–ç¨‹æ€æƒ³ï¼ŒAOPé‡‡ç”¨ä¸€ç§ç§°ä¸ºâ€œæ¨ªåˆ‡â€çš„æŠ€æœ¯ï¼Œå°†æ¶‰åŠå¤šä¸šåŠ¡æµç¨‹çš„é€šç”¨åŠŸèƒ½æŠ½å–å¹¶å•ç‹¬å°è£…ï¼Œå½¢æˆç‹¬ç«‹çš„åˆ‡é¢ï¼Œåœ¨åˆé€‚çš„æ—¶æœºå°†è¿™äº›åˆ‡é¢æ¨ªå‘åˆ‡å…¥åˆ°ä¸šåŠ¡æµç¨‹æŒ‡å®šçš„ä½ç½®ä¸­ã€‚</p>

<p>â€‹		 ç”¨è‡ªå·±é€šä¿—æ˜“æ‡‚çš„è¯æ¥è®²ï¼šä¸šåŠ¡æµç¨‹å¤§è‡´æ˜¯ä»request-&gt;controller-&gt;service-&gt;dao-&gt;dbï¼Œä¸€ç§ç«–ç€çš„ç»“æ„ï¼Œè€ŒAOPå°±æ˜¯æ¨ªå‘ç»‡å…¥ä¸šåŠ¡æµç¨‹</p>

<h2 id="äºŒæœ¯è¯­å®šä¹‰">äºŒã€æœ¯è¯­å®šä¹‰</h2>

<ul>
  <li>
    <p><strong>Aspectï¼ˆåˆ‡é¢ï¼‰</strong>*ï¼š Aspect å£°æ˜ç±»ä¼¼äº Java ä¸­çš„ç±»å£°æ˜ï¼Œåœ¨ Aspect ä¸­ä¼šåŒ…å«ç€ä¸€äº› Pointcut ä»¥åŠç›¸åº”çš„ Adviceã€‚</p>
  </li>
  <li>
    <p><strong>Joint pointï¼ˆè¿æ¥ç‚¹ï¼‰</strong>ï¼šè¡¨ç¤ºåœ¨ç¨‹åºä¸­æ˜ç¡®å®šä¹‰çš„ç‚¹ï¼Œå…¸å‹çš„åŒ…æ‹¬æ–¹æ³•è°ƒç”¨ï¼Œå¯¹ç±»æˆå‘˜çš„è®¿é—®ä»¥åŠå¼‚å¸¸å¤„ç†ç¨‹åºå—çš„æ‰§è¡Œç­‰ç­‰ï¼Œå®ƒè‡ªèº«è¿˜å¯ä»¥åµŒå¥—å…¶å®ƒ joint pointã€‚</p>
  </li>
  <li>
    <p><strong>Pointcutï¼ˆåˆ‡ç‚¹ï¼‰</strong>ï¼šè¡¨ç¤ºä¸€ç»„ joint pointï¼Œè¿™äº› joint point æˆ–æ˜¯é€šè¿‡é€»è¾‘å…³ç³»ç»„åˆèµ·æ¥ï¼Œæˆ–æ˜¯é€šè¿‡é€šé…ã€æ­£åˆ™è¡¨è¾¾å¼ç­‰æ–¹å¼é›†ä¸­èµ·æ¥ï¼Œå®ƒå®šä¹‰äº†ç›¸åº”çš„ Advice å°†è¦å‘ç”Ÿçš„åœ°æ–¹ã€‚</p>
  </li>
  <li>
    <p><strong>Adviceï¼ˆå¢å¼ºï¼‰</strong>ï¼šAdvice å®šä¹‰äº†åœ¨ Pointcut é‡Œé¢å®šä¹‰çš„ç¨‹åºç‚¹å…·ä½“è¦åšçš„æ“ä½œï¼Œå®ƒé€šè¿‡ beforeã€after å’Œ around æ¥åŒºåˆ«æ˜¯åœ¨æ¯ä¸ª joint point ä¹‹å‰ã€ä¹‹åè¿˜æ˜¯ä»£æ›¿æ‰§è¡Œçš„ä»£ç ã€‚</p>
  </li>
  <li>
    <p><strong>Targetï¼ˆç›®æ ‡å¯¹è±¡ï¼‰</strong>ï¼šç»‡å…¥ Advice çš„ç›®æ ‡å¯¹è±¡.ã€‚</p>
  </li>
  <li>
    <p><strong>Weavingï¼ˆç»‡å…¥ï¼‰</strong>ï¼šå°† Aspect å’Œå…¶ä»–å¯¹è±¡è¿æ¥èµ·æ¥, å¹¶åˆ›å»º Adviced object çš„è¿‡ç¨‹</p>
  </li>
</ul>

<p>â€‹		æœ¯è¯­å¯èƒ½ä¸å¤ªå¥½ç†è§£ï¼Œç”¨äºä¸€ä¸ªç±»æ¯”å…³ç³»å°±æ˜¯<code class="highlighter-rouge">Aspect</code>å°±æ˜¯å®šä¹‰åœ¨é¡¹ç›®ä¸­çš„xxxAOP,<code class="highlighter-rouge">Joint point</code>æ˜¯é¡¹ç›®ä¸­æ‰€æœ‰è¯·æ±‚å†…å®¹ï¼Œ<code class="highlighter-rouge">pointcut</code>æ˜¯ç”¨äºè®°å½•çš„å¯¹è±¡ï¼Œå¯ä»¥æ˜¯Controllerä¹Ÿå¯ä»¥æ˜¯Annotation</p>

<h2 id="ä¸‰é¡¹ç›®å®æˆ˜">ä¸‰ã€é¡¹ç›®å®æˆ˜</h2>

<h3 id="1æ—¥å¿—è®°å½•">1ã€æ—¥å¿—è®°å½•</h3>

<p>â€‹		AOPæœ€å¸¸è§çš„ä¸€ä¸ªåŠŸèƒ½å°±æ˜¯æ—¥å¿—è®°å½•ã€‚å¸¸ç”¨äºå‡ºå…¥å‚ä¿¡æ¯è®°å½•ï¼Œæ•æ„Ÿæ“ä½œè®°å½•ã€‚</p>

<h4 id="å‡ºå…¥å‚è®°å½•">â‘ å‡ºå…¥å‚è®°å½•</h4>

<p>â€‹		å¼€å‘é˜¶æ®µæˆ–è€…ç”Ÿäº§é˜¶æ®µå¯¹äºbugçš„å‡ºç°ï¼Œæœ‰æ—¶å€™å¯èƒ½æ˜¯ç”±æ•°æ®é€ æˆçš„é—®é¢˜è€Œéä»£ç çš„é—®é¢˜ï¼Œè¿™æ—¶å¯ä»¥åˆ©ç”¨Aopè®°å½•å‡ºå…¥å‚æ•°ï¼Œè§‚çœ‹å‚æ•°æ˜¯å¦ç¬¦åˆé¢„æœŸï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="nd">@Before</span><span class="o">(</span><span class="s">"log() "</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exBefore</span><span class="o">(</span><span class="nc">JoinPoint</span> <span class="n">joinPoint</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ServletRequestAttributes</span> <span class="n">requestAttributes</span> <span class="o">=</span> <span class="o">(</span><span class="nc">ServletRequestAttributes</span><span class="o">)</span> <span class="nc">RequestContextHolder</span><span class="o">.</span><span class="na">getRequestAttributes</span><span class="o">();</span>
        <span class="nc">HttpServletRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="n">requestAttributes</span><span class="o">.</span><span class="na">getRequest</span><span class="o">();</span>
        <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span> <span class="o">=</span> <span class="n">joinPoint</span><span class="o">.</span><span class="na">getArgs</span><span class="o">();</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"è¯·æ±‚url:{}"</span><span class="o">,</span> <span class="n">request</span><span class="o">.</span><span class="na">getRequestURL</span><span class="o">());</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"è¯·æ±‚type:{}"</span><span class="o">,</span> <span class="n">request</span><span class="o">.</span><span class="na">getMethod</span><span class="o">());</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"è¯·æ±‚method:{}"</span><span class="o">,</span> <span class="n">joinPoint</span><span class="o">.</span><span class="na">getSignature</span><span class="o">());</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"è¯·æ±‚å‚æ•°args:{}"</span><span class="o">,</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">args</span><span class="o">));</span>
    <span class="o">}</span>

	<span class="nd">@After</span><span class="o">(</span><span class="s">"log()"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exAfter</span><span class="o">(</span><span class="nc">JoinPoint</span> <span class="n">joinPoint</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"class method:{}.{}æ‰§è¡Œå®Œæ¯•!"</span><span class="o">,</span> <span class="n">joinPoint</span><span class="o">.</span><span class="na">getSignature</span><span class="o">().</span><span class="na">getDeclaringTypeName</span><span class="o">(),</span> <span class="n">joinPoint</span><span class="o">.</span><span class="na">getSignature</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@AfterReturning</span><span class="o">(</span><span class="n">returning</span> <span class="o">=</span> <span class="s">"result"</span><span class="o">,</span><span class="n">pointcut</span> <span class="o">=</span> <span class="s">"log()"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exAfterRunning</span><span class="o">(</span><span class="nc">Object</span> <span class="n">result</span><span class="o">){</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"æ‰§è¡Œè¿”å›å€¼:{}"</span><span class="o">,</span><span class="no">JSON</span><span class="o">.</span><span class="na">toJSON</span><span class="o">(</span><span class="n">result</span><span class="o">));</span>
    <span class="o">}</span>
</code></pre></div></div>

<h4 id="æ“ä½œè®°å½•">â‘¡æ“ä½œè®°å½•</h4>

<p>â€‹		å¯¹äºä¸€äº›æ¯”è¾ƒé‡è¦çš„æ“ä½œï¼Œè­¬å¦‚ç³»ç»Ÿç®¡ç†ï¼Œè¿™æ˜¯ä¸€ä¸ªç³»ç»Ÿé‡Œé¢æ“ä½œæ¯”è¾ƒå°‘çš„åŠŸèƒ½ï¼Œä½†æ¯ä¸€ä¸ªéƒ½æ˜¯æ¯”è¾ƒé‡è¦çš„åŠŸèƒ½ï¼Œæ‰€ä»¥å¯¹äºè¿™äº›æ“ä½œéœ€è¦åˆ©ç”¨AOPè®°å½•ä¸‹æ¥ï¼Œç„¶åå†™å…¥DBæ•°æ®åº“ï¼Œæ–¹ä¾¿æŸ¥çœ‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="nd">@Pointcut</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"@annotation(com.njzhxt.spaas.common.annotion.BussinessLog)"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">cutService</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="nd">@Around</span><span class="o">(</span><span class="s">"cutService()"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">recordSysLog</span><span class="o">(</span><span class="nc">ProceedingJoinPoint</span> <span class="n">point</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Throwable</span> <span class="o">{</span>
        <span class="c1">//å…ˆæ‰§è¡Œä¸šåŠ¡</span>
        <span class="nc">Object</span> <span class="n">result</span> <span class="o">=</span> <span class="n">point</span><span class="o">.</span><span class="na">proceed</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">handle</span><span class="o">(</span><span class="n">point</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"æ—¥å¿—è®°å½•å‡ºé”™!"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">handle</span><span class="o">(</span><span class="nc">ProceedingJoinPoint</span> <span class="n">point</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="c1">//è·å–æ‹¦æˆªçš„æ–¹æ³•å</span>
        <span class="nc">Signature</span> <span class="n">sig</span> <span class="o">=</span> <span class="n">point</span><span class="o">.</span><span class="na">getSignature</span><span class="o">();</span>
        <span class="nc">MethodSignature</span> <span class="n">msig</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(!(</span><span class="n">sig</span> <span class="k">instanceof</span> <span class="nc">MethodSignature</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"è¯¥æ³¨è§£åªèƒ½ç”¨äºæ–¹æ³•"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">msig</span> <span class="o">=</span> <span class="o">(</span><span class="nc">MethodSignature</span><span class="o">)</span> <span class="n">sig</span><span class="o">;</span>
        <span class="nc">Object</span> <span class="n">target</span> <span class="o">=</span> <span class="n">point</span><span class="o">.</span><span class="na">getTarget</span><span class="o">();</span>
        <span class="nc">Method</span> <span class="n">currentMethod</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getMethod</span><span class="o">(</span><span class="n">msig</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">msig</span><span class="o">.</span><span class="na">getParameterTypes</span><span class="o">());</span>
        <span class="nc">String</span> <span class="n">methodName</span> <span class="o">=</span> <span class="n">currentMethod</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
        <span class="nc">String</span> <span class="n">className</span> <span class="o">=</span> <span class="n">point</span><span class="o">.</span><span class="na">getTarget</span><span class="o">().</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">();</span>

        <span class="c1">//è·å–æ“ä½œåç§°</span>
        <span class="nc">BussinessLog</span> <span class="n">annotation</span> <span class="o">=</span> <span class="n">currentMethod</span><span class="o">.</span><span class="na">getAnnotation</span><span class="o">(</span><span class="nc">BussinessLog</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">bussinessName</span> <span class="o">=</span> <span class="n">annotation</span><span class="o">.</span><span class="na">value</span><span class="o">();</span>
        <span class="nc">String</span> <span class="n">key</span> <span class="o">=</span> <span class="n">annotation</span><span class="o">.</span><span class="na">key</span><span class="o">();</span>
        <span class="nc">Class</span> <span class="n">dictClass</span> <span class="o">=</span> <span class="n">annotation</span><span class="o">.</span><span class="na">dict</span><span class="o">();</span>
        <span class="nc">Object</span> <span class="n">arg</span> <span class="o">=</span> <span class="n">point</span><span class="o">.</span><span class="na">getArgs</span><span class="o">()[</span><span class="mi">0</span><span class="o">];</span>
        <span class="nc">String</span> <span class="n">msg</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">bussinessName</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">"ä¿®æ”¹"</span><span class="o">)</span> <span class="o">||</span> <span class="n">bussinessName</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">"ç¼–è¾‘"</span><span class="o">))</span> <span class="o">{</span>
            <span class="nc">Object</span> <span class="n">obj1</span> <span class="o">=</span> <span class="nc">LogObjectHolder</span><span class="o">.</span><span class="na">me</span><span class="o">().</span><span class="na">get</span><span class="o">();</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="nc">Contrast</span><span class="o">.</span><span class="na">contrastObj</span><span class="o">(</span><span class="n">dictClass</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">obj1</span><span class="o">,</span> <span class="n">arg</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="nc">AbstractDictMap</span> <span class="n">dictMap</span> <span class="o">=</span> <span class="o">(</span><span class="nc">AbstractDictMap</span><span class="o">)</span> <span class="n">dictClass</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="nc">Contrast</span><span class="o">.</span><span class="na">parseMutiKey</span><span class="o">(</span><span class="n">dictMap</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">arg</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">operationLogService</span><span class="o">.</span><span class="na">insertOperationLog</span><span class="o">(</span><span class="nc">LogType</span><span class="o">.</span><span class="na">BUSSINESS</span><span class="o">,</span><span class="nc">LogSucceed</span><span class="o">.</span><span class="na">SUCCESS</span><span class="o">,</span><span class="n">bussinessName</span><span class="o">,</span><span class="n">className</span><span class="o">,</span><span class="n">methodName</span><span class="o">,</span><span class="n">msg</span><span class="o">);</span>
    <span class="o">}</span>
</code></pre></div></div>

<p><img src="http://image.yangyhao.top/image-20191204102820565.png" alt="image-20191204102820565" /></p>

<h3 id="2å‚æ•°æ ¡éªŒ">2ã€å‚æ•°æ ¡éªŒ</h3>

<p>â€‹		æˆ‘ä»¬è¿›è¡Œä¸šåŠ¡ä»£ç ç¼–å†™çš„æ—¶å€™ç»å¸¸éœ€è¦å¯¹å‚æ•°è¿›è¡Œæ ¡éªŒï¼Œçœ‹æ˜¯å¦ç¬¦åˆé¢„æœŸï¼Œé‚£ä¹ˆå°±ä¼šå†™ä¸‹å¦‚ä¸‹çš„ä»£ç ï¼š</p>

<p><img src="http://image.yangyhao.top/image-20191204103202906.png" alt="image-20191204103202906" /></p>

<p>â€‹		å†™å¤šäº†ï¼Œå°±ä¼šæ„Ÿè§‰å¾ˆéº»çƒ¦ï¼Œé‚£ä¹ˆæœ‰æ²¡æœ‰èƒ½å¤Ÿä¼˜åŒ–ä½“éªŒçš„å‘¢ï¼Ÿ</p>

<p>â€‹		è‚¯å®šæœ‰ï¼Œé‚£å°±æ˜¯<a href="https://www.ibm.com/developerworks/cn/java/j-lo-jsr303/index.html">JSR303æ•°æ®æ ¡éªŒ</a></p>

<p>â€‹		å†™æ³•å¦‚ä¸‹ï¼š</p>

<p>â€‹		1ï¼‰é¦–å…ˆåœ¨éœ€è¦æ ¡éªŒçš„å¯¹è±¡ä¸Šé¢åŠ ä¸ŠJSR303çš„æ³¨è§£ï¼Œæ¯”å¦‚<code class="highlighter-rouge">@Length</code>ï¼Œ<code class="highlighter-rouge">@NotBlank</code></p>

<p>â€‹		2ï¼‰åœ¨controllerä¸Šå¯¹å¯¹è±¡åŠ ä¸Š@Validæ³¨è§£ï¼Œåé¢åŠ ä¸Šå‚æ•°<code class="highlighter-rouge">BindingResult</code></p>

<p>â€‹		3ï¼‰ç„¶ååœ¨å¤„ç†ä¸šåŠ¡ä¹‹å‰åˆ¤æ–­æ ¡éªŒæ˜¯å¦æœ‰é”™è¯¯ï¼Œæœ‰é”™è¯¯å°±æŠ›å‡ºå¼‚å¸¸</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">ResponseData</span> <span class="nf">add</span><span class="o">(</span><span class="nd">@RequestBody</span> <span class="nd">@Valid</span> <span class="nc">MenuDTO</span> <span class="n">menuDTO</span><span class="o">,</span> <span class="nc">BindingResult</span> <span class="n">result</span><span class="o">){</span>
        <span class="k">if</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">hasErrors</span><span class="o">()){</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">();</span>
        <span class="o">}</span>
		<span class="o">...</span>       
<span class="o">}</span>
</code></pre></div></div>

<p>â€‹		è¿™æ ·çœ‹èµ·æ¥ç®€å•äº†å¾ˆå¤šï¼Œä½†æ˜¯æ¯ä¸€ä¸ªä¸šåŠ¡æ–¹æ³•è¿˜æ˜¯éœ€è¦åˆ¤æ–­å‚æ•°æ˜¯å¦æœ‰é”™è¯¯ï¼Œçœ‹èµ·æ¥è¿˜æ˜¯ä¸å¤Ÿç®€æ´å•Šï¼Œé‚£ä¹ˆAOPå¯ä»¥ä»ä¸­ä½œå‡ºå“ªäº›ä¼˜åŒ–å‘¢ï¼Ÿ</p>

<p>â€‹		æ€è·¯å¾ˆç®€å•ï¼ŒAOPå¯ä»¥è·å–åˆ°SpringMVCçš„å…¥å‚ï¼Œç„¶åå¦‚æœæœ‰BindingResultçš„åˆ™ç»Ÿä¸€è¿›è¡Œæ ¡éªŒå³å¯ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="nd">@Before</span><span class="o">(</span><span class="s">"log() "</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exBefore</span><span class="o">(</span><span class="nc">JoinPoint</span> <span class="n">joinPoint</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span> <span class="o">=</span> <span class="n">joinPoint</span><span class="o">.</span><span class="na">getArgs</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Object</span> <span class="n">arg</span> <span class="o">:</span><span class="n">args</span><span class="o">){</span>
            <span class="k">if</span><span class="o">(</span><span class="n">arg</span> <span class="k">instanceof</span> <span class="nc">BindingResult</span><span class="o">){</span>
                <span class="nc">BindingResult</span> <span class="n">bindingResult</span> <span class="o">=</span> <span class="o">(</span><span class="nc">BindingResult</span><span class="o">)</span> <span class="n">arg</span><span class="o">;</span>
                <span class="nc">APIResult</span> <span class="n">result</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">vaildReuqestParams</span><span class="o">(</span><span class="n">bindingResult</span><span class="o">);</span>
                <span class="k">if</span><span class="o">(!</span><span class="n">result</span><span class="o">.</span><span class="na">isSuccess</span><span class="o">()){</span>
                    <span class="c1">//å¦‚æœç»‘å®šå¤±è´¥åˆ™æŠ›å‡ºå¼‚å¸¸</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">BindErrorException</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">getData</span><span class="o">().</span><span class="na">toString</span><span class="o">());</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

	<span class="kd">private</span> <span class="nc">APIResult</span> <span class="nf">vaildReuqestParams</span><span class="o">(</span><span class="nc">BindingResult</span> <span class="n">bindingResult</span><span class="o">){</span>
        <span class="k">if</span><span class="o">(</span><span class="n">bindingResult</span><span class="o">.</span><span class="na">hasErrors</span><span class="o">()){</span>
            <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ObjectError</span><span class="o">&gt;</span> <span class="n">allErrors</span> <span class="o">=</span> <span class="n">bindingResult</span><span class="o">.</span><span class="na">getAllErrors</span><span class="o">();</span>
            <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">ObjectError</span> <span class="n">error</span> <span class="o">:</span><span class="n">allErrors</span><span class="o">){</span>
                <span class="nc">FieldError</span> <span class="n">fieldError</span> <span class="o">=</span> <span class="o">(</span><span class="nc">FieldError</span><span class="o">)</span> <span class="n">error</span><span class="o">;</span>
                <span class="c1">//é”™è¯¯ä¿¡æ¯æ‹¼æ¥</span>
                <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">fieldError</span><span class="o">.</span><span class="na">getField</span><span class="o">()+</span><span class="n">error</span><span class="o">.</span><span class="na">getDefaultMessage</span><span class="o">());</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="nc">APIResult</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="nc">BaseEnum</span><span class="o">.</span><span class="na">PARAM_HAS_ERROR</span><span class="o">,</span><span class="n">list</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="nc">APIResult</span><span class="o">.</span><span class="na">ok</span><span class="o">();</span>
    <span class="o">}</span>
</code></pre></div></div>

<p>â€‹		é‚£è¿™æ ·å°±å¯ä»¥å¾ˆæ„‰å¿«çš„æŠ›å¼ƒç¹ççš„å‚æ•°æ ¡éªŒäº†</p>

<h3 id="3æ’å…¥æ£€æŸ¥">3ã€æ’å…¥æ£€æŸ¥</h3>

<p>â€‹		å¯¹äºInsertå’ŒUpdateæ“ä½œï¼Œå…³é”®å­—æ®µçš„æ•°æ®é‡å¤è‚¯å®šæ˜¯æ— æ³•æ¥å—çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å†™ä»£ç åœ¨æ’å…¥æ•°æ®ä¹‹å‰è‚¯å®šä¼šæœ‰é‡å¤æ€§æ£€æŸ¥ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>List&lt;Menu&gt; exist = sqlManager.query(Menu.class)
                .andEq("name", menuDTO.getName())
                .andEq("code", menuDTO.getCode())
                .select();
</code></pre></div></div>

<p>â€‹		å…¶å®è¿™äº›æ“ä½œå®Œæˆå¯ä»¥é€šè¿‡AOPå®ç°ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="nd">@Pointcut</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"@annotation(com.njzhxt.spaas.common.annotion.InsertCheck)"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">check</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="nd">@Before</span><span class="o">(</span><span class="s">"check()"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">insertCheck</span><span class="o">(</span><span class="nc">JoinPoint</span> <span class="n">joinPoint</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IllegalAccessException</span> <span class="o">{</span>
        <span class="nc">MethodSignature</span> <span class="n">ms</span> <span class="o">=</span> <span class="o">(</span><span class="nc">MethodSignature</span><span class="o">)</span> <span class="n">joinPoint</span><span class="o">.</span><span class="na">getSignature</span><span class="o">();</span>
        <span class="nc">Method</span> <span class="n">method</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="na">getMethod</span><span class="o">();</span>
        <span class="c1">//è·å–æ³¨è§£</span>
        <span class="nc">InsertCheck</span> <span class="n">annotation</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">getAnnotation</span><span class="o">(</span><span class="nc">InsertCheck</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="c1">//è·å–æ³¨è§£å†…çš„å‚æ•°</span>
        <span class="nc">String</span><span class="o">[]</span> <span class="n">eqFields</span> <span class="o">=</span> <span class="n">annotation</span><span class="o">.</span><span class="na">eqFields</span><span class="o">();</span>
        <span class="nc">String</span><span class="o">[]</span> <span class="n">noEqFields</span> <span class="o">=</span> <span class="n">annotation</span><span class="o">.</span><span class="na">noEqFields</span><span class="o">();</span>
        <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span> <span class="o">=</span> <span class="n">joinPoint</span><span class="o">.</span><span class="na">getArgs</span><span class="o">();</span>
        <span class="nc">StringBuilder</span> <span class="n">sb</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">(</span><span class="s">"where 1=1 "</span><span class="o">);</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">typeList</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">types</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Object</span> <span class="n">arg</span> <span class="o">:</span><span class="n">args</span><span class="o">){</span>
            <span class="c1">//è·å–ç±»å‹åç§°</span>
            <span class="nc">String</span> <span class="n">typeName</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getTypeName</span><span class="o">();</span>
            <span class="k">if</span><span class="o">(</span><span class="n">typeList</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">typeName</span><span class="o">)){</span>
                <span class="c1">//å¦‚æœæ˜¯åŸºç¡€ç±»å‹</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æš‚ä¸æ£€æµ‹åŸºæœ¬ç±»å‹"</span><span class="o">);</span>
            <span class="o">}</span><span class="k">else</span> <span class="o">{</span>
                <span class="k">if</span><span class="o">(!(</span><span class="n">arg</span> <span class="k">instanceof</span> <span class="nc">TailBean</span><span class="o">)){</span>
                    <span class="k">return</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="c1">//å¦‚æœä¸æ˜¯åŸºç¡€ç±»å‹ï¼Œæ˜¯å¯¹è±¡åˆ™åˆ©ç”¨åå°„è·å–</span>
                <span class="nc">Field</span><span class="o">[]</span> <span class="n">fields</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getDeclaredFields</span><span class="o">();</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">eq</span> <span class="o">:</span><span class="n">eqFields</span><span class="o">){</span>
                    <span class="k">for</span> <span class="o">(</span><span class="nc">Field</span> <span class="n">field</span> <span class="o">:</span> <span class="n">fields</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">field</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
                        <span class="k">if</span><span class="o">(</span><span class="n">eq</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">field</span><span class="o">.</span><span class="na">getName</span><span class="o">())){</span>
                            <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">" and "</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="nc">StringUtil</span><span class="o">.</span><span class="na">camel2Underscore</span><span class="o">(</span><span class="n">eq</span><span class="o">)).</span><span class="na">append</span><span class="o">(</span><span class="s">" = "</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="s">"'"</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">field</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">arg</span><span class="o">)).</span><span class="na">append</span><span class="o">(</span><span class="s">"'"</span><span class="o">);</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">noEq</span> <span class="o">:</span> <span class="n">noEqFields</span><span class="o">){</span>
                    <span class="k">for</span> <span class="o">(</span><span class="nc">Field</span> <span class="n">field</span> <span class="o">:</span> <span class="n">fields</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">field</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
                        <span class="k">if</span><span class="o">(</span><span class="n">noEq</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">field</span><span class="o">.</span><span class="na">getName</span><span class="o">())){</span>
                            <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">" and "</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="nc">StringUtil</span><span class="o">.</span><span class="na">camel2Underscore</span><span class="o">(</span><span class="n">noEq</span><span class="o">)).</span><span class="na">append</span><span class="o">(</span><span class="s">" &lt;&gt; "</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="s">"'"</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">field</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">arg</span><span class="o">)).</span><span class="na">append</span><span class="o">(</span><span class="s">"'"</span><span class="o">);</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="nc">List</span><span class="o">&lt;?&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="n">sqlManager</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">arg</span><span class="o">.</span><span class="na">getClass</span><span class="o">()).</span><span class="na">appendSql</span><span class="o">(</span><span class="n">sb</span><span class="o">.</span><span class="na">toString</span><span class="o">()).</span><span class="na">select</span><span class="o">();</span>
                <span class="k">if</span><span class="o">(</span><span class="nc">CollectionUtils</span><span class="o">.</span><span class="na">isNotEmpty</span><span class="o">(</span><span class="n">list</span><span class="o">)){</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">ServiceException</span><span class="o">(</span><span class="nc">BizExceptionEnum</span><span class="o">.</span><span class="na">CAN_NOT_ADD_AGAIN</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æ’å…¥æ ¡éªŒæ£€æµ‹é€šè¿‡"</span><span class="o">);</span>
                <span class="k">return</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>

    <span class="o">}</span>
</code></pre></div></div>

<p>â€‹			ä¹‹åå®Œå…¨å¯ä»¥åˆ©ç”¨æ³¨è§£å®ç°äº†ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="nd">@InsertCheck</span><span class="o">(</span><span class="n">eqFields</span> <span class="o">=</span> <span class="o">{</span><span class="s">"name"</span><span class="o">,</span><span class="s">"code"</span><span class="o">})</span>
</code></pre></div></div>

<p>â€‹			å½“ç„¶è¿™é‡Œåªæ˜¯ç®€å•çš„æ ¡éªŒï¼Œå¦‚æœæ¶‰åŠå¤æ‚çš„æŸ¥è¯¢åˆ¤æ–­ï¼Œæ¯”å¦‚ and a= xxx or b=xxx æˆ–è€…ï¼ˆï¼‰è¿™äº›å¯ä»¥å»æ›´æ·±å±‚æ¬¡çš„ç ”ç©¶ã€‚</p>

<h2 id="å››æºç è§£æ">å››ã€æºç è§£æ</h2>

<p>â€‹			é¦–å…ˆæˆ‘ä»¬çŸ¥é“AOPæ˜¯é€šè¿‡åŠ¨æ€ä»£ç†å®ç°çš„ï¼Œè€ŒåŠ¨æ€ä»£ç†åˆåˆ†ä¸ºJDKåŠ¨æ€ä»£ç†å’ŒCGLIBåŠ¨æ€ä»£ç†.</p>

<p>â€‹			ä»£ç†æ¨¡å¼å¾ˆç®€å•ï¼Œæ¥å£ + çœŸå®å®ç°ç±» + ä»£ç†ç±»ï¼Œå…¶ä¸­ çœŸå®å®ç°ç±» å’Œ ä»£ç†ç±» éƒ½è¦å®ç°æ¥å£ï¼Œå®ä¾‹åŒ–çš„æ—¶å€™è¦ä½¿ç”¨ä»£ç†ç±»ã€‚æ‰€ä»¥ï¼ŒSpring AOP éœ€è¦åšçš„æ˜¯ç”Ÿæˆè¿™ä¹ˆä¸€ä¸ªä»£ç†ç±»ï¼Œç„¶å<strong>æ›¿æ¢æ‰</strong>çœŸå®å®ç°ç±»æ¥å¯¹å¤–æä¾›æœåŠ¡ã€‚</p>

<p>â€‹			æ›¿æ¢çš„è¿‡ç¨‹æ€ä¹ˆç†è§£å‘¢ï¼Ÿåœ¨ Spring IOC å®¹å™¨ä¸­éå¸¸å®¹æ˜“å®ç°ï¼Œå°±æ˜¯åœ¨ getBean(â€¦) çš„æ—¶å€™è¿”å›çš„å®é™…ä¸Šæ˜¯ä»£ç†ç±»çš„å®ä¾‹ï¼Œè€Œè¿™ä¸ªä»£ç†ç±»æˆ‘ä»¬è‡ªå·±æ²¡å†™ä»£ç ï¼Œå®ƒæ˜¯ Spring é‡‡ç”¨ JDK Proxy æˆ– CGLIB åŠ¨æ€ç”Ÿæˆçš„ã€‚</p>

<p>â€‹			å¤§å®¶éƒ½çŸ¥é“mybatis çš„mapperå°±æ˜¯é€šè¿‡JDKçš„åŠ¨æ€å®ç°çš„ï¼Œè€Œå¯¹äºAOPçš„è§„åˆ™å¾ˆç›¸ä¼¼ï¼Œå¯¹äºæ¥å£å›ä½¿ç”¨JDKä»£ç†ï¼Œå…¶ä»–çš„ç”¨CGLIBã€‚</p>
:ET